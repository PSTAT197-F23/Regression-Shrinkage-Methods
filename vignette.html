<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ryan Yee &amp; Aaron Lee">
<meta name="dcterms.date" content="2023-12-06">

<title>Vignette - Regression Shrinkage Methods</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="vignette_files/libs/clipboard/clipboard.min.js"></script>
<script src="vignette_files/libs/quarto-html/quarto.js"></script>
<script src="vignette_files/libs/quarto-html/popper.min.js"></script>
<script src="vignette_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="vignette_files/libs/quarto-html/anchor.min.js"></script>
<link href="vignette_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="vignette_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="vignette_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="vignette_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="vignette_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Vignette - Regression Shrinkage Methods</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ryan Yee &amp; Aaron Lee </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 6, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="abstract" class="level2">
<h2 class="anchored" data-anchor-id="abstract">Abstract</h2>
<p>This project explores the application of regularization techniques, specifically Ridge and Lasso regression, to predict Major League Baseball (MLB) player salaries based on various player statistics from the 1986 and 1987 seasons. Using the Hitters dataset, the study investigates the impact of Ridge and Lasso regression in handling multicollinearity and variable selection. The process involves data exploration, tidying, and the implementation of both Ridge and Lasso regression models. The project further delves into the integration of Principal Component Analysis (PCA) to address collinearity in predictor variables. Finally, an Elastic Net regression model is employed, combining Lasso and Ridge penalties. The hyperparameter tuning process, model selection, and the evaluation of the chosen model’s performance are also discussed. This comprehensive analysis provides insights into the effectiveness of different regularization techniques in statistical modeling.</p>
</section>
<section id="introducing-shrinkage-method" class="level2">
<h2 class="anchored" data-anchor-id="introducing-shrinkage-method">Introducing Shrinkage Method</h2>
<section id="ridge-regression" class="level3">
<h3 class="anchored" data-anchor-id="ridge-regression">Ridge Regression</h3>
<p>The purpose of ridge regression is to estimate the parameter <span class="math inline">\(\beta\)</span> in the linear model.</p>
<p><span class="math display">\[\begin{align*}
y = X\beta + \varepsilon, \quad \varepsilon \sim \mathcal(0, \sigma^2 I_n)
\end{align*}\]</span></p>
<p>where X is <span class="math inline">\(N\times(p+1)\)</span> real matrix with full column rank (rank = p + 1), and the first column a column of 1’s</p>
<p>Ridge regression:</p>
<p><span class="math display">\[\begin{align*}
\hat{\beta}^{ridge} = \arg\min_{\beta} \left\{ \|y - X\beta\|_2^2 + \lambda \|\beta\|_2^2 \right\}
\end{align*}\]</span></p>
<p>where:</p>
<p><span class="math display">\[\begin{align*}
\hat{\beta}^{ridge} &amp; : \text{Ridge regression coefficient estimates} \\
\beta &amp; : \text{Regression coefficient vector} \\
X &amp; : \text{Design matrix} \\
y &amp; : \text{Response variable vector} \\
\lambda &amp; : \text{Ridge regularization parameter} \\
\| \cdot \|_2 &amp; : \text{L2 norm (Euclidean norm)}
\end{align*}\]</span></p>
<p>which can also be written as:</p>
<p><span class="math display">\[\begin{align*}
\hat{\beta}^{ridge} = \arg\min_{\beta} \left\{ \sum_{i=1}^{N}(y_i - \beta_0 - \sum_{j=1}^{p}x_{ij}\beta_j)^2 + \lambda(\sum_{j=1}^{p}\beta_{j}^2) \right\}
\end{align*}\]</span></p>
<p>this is equivalent to finding:</p>
<p><span class="math display">\[\begin{align*}
\hat{\beta}^{ridge} = \arg\min_{\beta} \left\{ \sum_{i=1}^{N}(y_i - \beta_0 - \sum_{j=1}^{p}x_{ij}\beta_j)^2 \right\} \quad subject \space to \quad \sum_{j=1}^{p}\beta_{j}^2 \leq t^2
\end{align*}\]</span></p>
<p>There exist an 1 to 1 correspondence between <span class="math inline">\(\lambda\)</span> and t in above formulation.</p>
<p>Found that <span class="math inline">\(\sum_{i=1}^{N}(y_i - \beta_0 - \sum_{j=1}^{p}x_{ij}\beta_j)^2\)</span> is the sum square residual (RSS), <span class="math inline">\(\lambda\)</span> is the penalty parameter. The L2 regularization term is added to the ordinary least squares (OLS) objective function to prevent overfitting and to handle multicollinearity among the predictor variables. No penalty for the intercept <span class="math inline">\(\beta_0\)</span>.</p>
<p><span class="math display">\[\begin{align*}
\lambda \geq 0
\end{align*}\]</span></p>
<ul>
<li><p>if <span class="math inline">\(\lambda = 0\)</span>, then the <span class="math inline">\(\hat{\beta}^{ridge}\)</span> will be ordinary least squares (OLS).</p></li>
<li><p>if <span class="math inline">\(\lambda \to \infty\)</span>, the penalty parameter will shrink all coefficient estimates closer to zero vector. (except intercept <span class="math inline">\(\beta_0\)</span>)</p></li>
</ul>
<p>If the columns of X are each centered, and where there is no intercept, then the ridge estimate of <span class="math inline">\(\beta\)</span> in model <span class="math inline">\(y = X\beta + \varepsilon\)</span> minimizes a penalized least squares criterion.</p>
<p><span class="math display">\[\begin{align*}
RSS(\lambda) = (y - X\beta)^T(y - X\beta) + \lambda \beta^T \beta
\end{align*}\]</span></p>
<p><span class="math display">\[\begin{align*}
\hat{\beta}^{ridge} = (X^T X + \lambda I)^{-1} X^T Y
\end{align*}\]</span></p>
<p>which is a linear function of Y, therefore this estimator is a linear estimator.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img\ridge_lasso_regression.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Image of Ridge regression and Lasso regression</figcaption>
</figure>
</div>
<p>In the picture above, p = 2 (2 parameters, not including the intercept). The <span class="math inline">\(\hat{\beta}^{ridge}\)</span> lies either on the boundary of the circle or interior to the circle.</p>
<ul>
<li><p>As <span class="math inline">\(\lambda \to \infty\)</span> (or <span class="math inline">\(t \to 0\)</span>), <span class="math inline">\(\hat{\beta}^{ridge} \to 0\)</span>.</p></li>
<li><p>As <span class="math inline">\(\lambda \to 0\)</span> (or <span class="math inline">\(t \to \infty\)</span>), <span class="math inline">\(\hat{\beta}^{ridge} \to \hat{\beta}^{OLS}\)</span>.</p></li>
</ul>
<hr>
</section>
<section id="lasso-regression" class="level3">
<h3 class="anchored" data-anchor-id="lasso-regression">Lasso Regression</h3>
<p>Different from ridge regression, lasso regression is a L1 penalty approach. The purpose is also to estimate <span class="math inline">\(\beta\)</span> in linear model. Notable, lasso also does variable selection.</p>
<p>Lasso regression:</p>
<p><span class="math display">\[\begin{align*}
\hat{\beta}^{lasso} = \arg\min_{\beta} \left\{ \|y - X\beta\|_2^2 + \lambda \|\beta\|_1 \right\}
\end{align*}\]</span></p>
<p>where:</p>
<p><span class="math display">\[\begin{align*}
\hat{\beta}^{lasso} &amp; : \text{Lasso regression coefficient estimates} \\
\beta &amp; : \text{Regression coefficient vector} \\
X &amp; : \text{Design matrix} \\
y &amp; : \text{Response variable vector} \\
\lambda &amp; : \text{Lasso regularization parameter} \\
\| \cdot \|_2 &amp; : \text{L2 norm (Euclidean norm)} \\
\| \cdot \|_1 &amp; : \text{L1 norm (Manhattan norm)}
\end{align*}\]</span></p>
<p>which can also be written as:</p>
<p><span class="math display">\[\begin{align*}
\hat{\beta}^{lasso} = \arg\min_{\beta} \left\{ \sum_{i=1}^{N}(y_i - \beta_0 - \sum_{j=1}^{p}x_{ij}\beta_j)^2 + \lambda(\sum_{j=1}^{p}|\beta_{j}|) \right\}
\end{align*}\]</span></p>
<p>this is equivalent to finding:</p>
<p><span class="math display">\[\begin{align*}
\hat{\beta}^{lasso} = \arg\min_{\beta} \left\{ \sum_{i=1}^{N}(y_i - \beta_0 - \sum_{j=1}^{p}x_{ij}\beta_j)^2 \right\} \quad subject \space to \quad \sum_{j=1}^{p}|\beta_{j}| \leq t^2
\end{align*}\]</span></p>
<p>There exist an 1 to 1 correspondence between <span class="math inline">\(\lambda\)</span> and t in above formulation.</p>
<p>The different between ridge regression and lasso regression is that ridge regression never set parameter to 0, yet lasso regression does.</p>
<hr>
</section>
</section>
<section id="regression-baseball-salaries" class="level2">
<h2 class="anchored" data-anchor-id="regression-baseball-salaries">Regression: Baseball salaries</h2>
<p>We’ll use the <code>Hitters</code> data set to illustrate a regression problem. <code>Hitters</code> is included in the <code>ISLR</code> package. Let’s take a look at the data:</p>
<section id="loading-packages" class="level3">
<h3 class="anchored" data-anchor-id="loading-packages">Loading Packages</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ISLR) <span class="co"># load  Major League Baseball Data from the 1986 and 1987 season</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ISLR2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modeldata)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggthemes)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor) <span class="co"># for naming conventions</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar) <span class="co"># to assess missing data patterns</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot) <span class="co"># for a correlation plot</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(themis) <span class="co"># for upsampling</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">tidymodels_prefer</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our goal to predict baseball players’ <code>Salary</code> based on several different characteristics which are included in the data set, like their number of times at bat, number of hits, division, etc.</p>
<hr>
</section>
<section id="exploring-our-data" class="level3">
<h3 class="anchored" data-anchor-id="exploring-our-data">Exploring our data</h3>
<p>The Hitters data set includes the Major League Baseball (MLB) Data from the 1986 and 1987 seasons. In this data frame, there are 322 observations (rows) of major league players with 20 variables (columns).</p>
<ul>
<li><code>AtBat</code>: The number of times a player at bat in 1986 season.</li>
<li><code>Hits</code>: The number of a player hits in 1986 season.</li>
<li><code>HmRun</code>: The number of Home runs in 1986 season.</li>
<li><code>Runs</code>: The number of runs in 1986 season.</li>
<li><code>RBI</code>: The number of runs batted in 1986 season.</li>
<li><code>Walks</code>: The number of walks in 1986 season.</li>
<li><code>Years</code>: The number of years the player stayed in the major leagues.</li>
<li><code>CAtBat</code>: The number of times at bat during career.</li>
<li><code>CHits</code>: The number of hits during career.</li>
<li><code>CHmRun</code>: The number of home runs during career.</li>
<li><code>CRuns</code>: The number of runs during career.</li>
<li><code>CRBI</code>: The number of runs batted in during career.</li>
<li><code>CWalks</code>: The number of walks during career.</li>
<li><code>League</code>: A factor with levels A and N indicating player’s league at the end of 1986.</li>
<li><code>Division</code>: A factor with levels E and W indicating player’s division at the end of 1986.</li>
<li><code>PutOuts</code>: The number of put outs in 1986 season.</li>
<li><code>Assists</code>: The number of assists in 1986 season.</li>
<li><code>Errors</code>: The number of errors in 1986 season.</li>
<li><code>Salary</code>: 1987 annual salary on opening day in thousands of dollars.</li>
<li><code>NewLeague</code>: A factor with levels A and N indicating player’s league at the beginning of 1987.</li>
</ul>
<hr>
</section>
<section id="tidying-the-data" class="level3">
<h3 class="anchored" data-anchor-id="tidying-the-data">Tidying the Data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>hitters <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(Hitters)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hitters)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 20
  AtBat  Hits HmRun  Runs   RBI Walks Years CAtBat CHits CHmRun CRuns  CRBI
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt;
1   293    66     1    30    29    14     1    293    66      1    30    29
2   315    81     7    24    38    39    14   3449   835     69   321   414
3   479   130    18    66    72    76     3   1624   457     63   224   266
4   496   141    20    65    78    37    11   5628  1575    225   828   838
5   321    87    10    39    42    30     2    396   101     12    48    46
6   594   169     4    74    51    35    11   4408  1133     19   501   336
# ℹ 8 more variables: CWalks &lt;int&gt;, League &lt;fct&gt;, Division &lt;fct&gt;,
#   PutOuts &lt;int&gt;, Assists &lt;int&gt;, Errors &lt;int&gt;, Salary &lt;dbl&gt;, NewLeague &lt;fct&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>hitters <span class="ot">&lt;-</span> hitters <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(hitters)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 20
  at_bat  hits hm_run  runs   rbi walks years c_at_bat c_hits c_hm_run c_runs
   &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;  &lt;int&gt;    &lt;int&gt;  &lt;int&gt;
1    293    66      1    30    29    14     1      293     66        1     30
2    315    81      7    24    38    39    14     3449    835       69    321
3    479   130     18    66    72    76     3     1624    457       63    224
4    496   141     20    65    78    37    11     5628   1575      225    828
5    321    87     10    39    42    30     2      396    101       12     48
6    594   169      4    74    51    35    11     4408   1133       19    501
# ℹ 9 more variables: crbi &lt;int&gt;, c_walks &lt;int&gt;, league &lt;fct&gt;, division &lt;fct&gt;,
#   put_outs &lt;int&gt;, assists &lt;int&gt;, errors &lt;int&gt;, salary &lt;dbl&gt;, new_league &lt;fct&gt;</code></pre>
</div>
</div>
<p>Here we use the the <code>clean_names()</code> function, comparing before and after using this function, we would found that the column name have became at lot more neat (the column name of the dataset are likely to be transformed into lowercase, and the dots or space are replaced with underscores). Which shows that <code>clean_names()</code> is useful because it makes the column names more standardized and easier to work with.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>hitters_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(hitters, <span class="at">strata =</span> <span class="st">"salary"</span>, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>hitters_train <span class="ot">&lt;-</span> <span class="fu">training</span>(hitters_split) <span class="co"># training data set</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>hitters_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(hitters_split) <span class="co"># testing data set</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create 10-fold cross-validation splits</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>hitters_fold <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(hitters_train, <span class="at">v =</span> <span class="dv">10</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now visualizing the missingness within the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vis_miss</span>(hitters)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="vignette_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now, we found that there are missing data, we could use function <code>na.omit()</code> to remove the observation with missing value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>Hitters_clear <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(hitters)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">vis_miss</span>(Hitters_clear)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="vignette_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<hr>
</section>
<section id="perform-ridge-lasso-regression" class="level3">
<h3 class="anchored" data-anchor-id="perform-ridge-lasso-regression">Perform Ridge &amp; Lasso regression</h3>
<p>Our goal to predict baseball players’ Salary using ridge regression and lasso regression based on several different characteristics which are included in the data set, like their number of times at bat, number of hits, division, etc.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># use to produce a matrix corresponding to the predictor variables.</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(salary<span class="sc">~</span>., Hitters_clear)[,<span class="sc">-</span><span class="dv">1</span>] <span class="co"># removing the intercept</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> Hitters_clear<span class="sc">$</span>salary <span class="co"># response variable: the salary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ridge Regression</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="fu">seq</span>(<span class="dv">10</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="at">length =</span> <span class="dv">100</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>ridge_mod <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(x, y, <span class="at">alpha =</span> <span class="dv">0</span>, <span class="at">lambda =</span> grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By default, the <code>glmnet()</code> function performs ridge regression for an automatically selected range of <span class="math inline">\(\lambda\)</span> values. However, here we have chosen to implement the function over a grid of values ranging from <span class="math inline">\(\lambda = 10^{10}\)</span> to <span class="math inline">\(\lambda = 10^{-2}\)</span>, essentially covering the full range of scenarios from the null model (<span class="math inline">\(\lambda\)</span> very large) containing only the intercept, to the least squares fit (<span class="math inline">\(\lambda\)</span> = 0).</p>
<p>The variables in <code>glmnet()</code> function:</p>
<p>lambda: the range of lambda value</p>
<p>alpha: determining what type of model is fitting.</p>
<ul>
<li><p>alpha = 1: showing the lasso regression model is fitting (the default value)</p></li>
<li><p>alpha = 0: showing the ridge regression model is fitting</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ridge_mod<span class="sc">$</span>lambda[<span class="dv">70</span>] <span class="co"># displaying the 70th lambda value</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 43.28761</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(ridge_mod)[,<span class="dv">70</span>] <span class="co"># displaying coefficients </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  (Intercept)        at_bat          hits        hm_run          runs 
  54.97384215   -0.41480601    2.10530493   -1.34828331    1.13281252 
          rbi         walks         years      c_at_bat        c_hits 
   0.79219405    2.83508432   -6.85814163    0.00438123    0.11187771 
     c_hm_run        c_runs          crbi       c_walks       leagueN 
   0.64020753    0.23468562    0.22724180   -0.17405551   47.59278798 
    divisionW      put_outs       assists        errors   new_leagueN 
-119.52546741    0.25369445    0.13095051   -3.38369142  -11.36670636 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">coef</span>(ridge_mod)[<span class="sc">-</span><span class="dv">1</span>,<span class="dv">70</span>]<span class="sc">^</span><span class="dv">2</span>) <span class="co"># Calculate L2 norm squared</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 16756.11</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ridge_mod<span class="sc">$</span>lambda[<span class="dv">60</span>] <span class="co">#Display 60th lambda value</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 705.4802</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(ridge_mod)[,<span class="dv">60</span>] <span class="co"># Display coefficients</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> (Intercept)       at_bat         hits       hm_run         runs          rbi 
 54.32519950   0.11211115   0.65622409   1.17980910   0.93769713   0.84718546 
       walks        years     c_at_bat       c_hits     c_hm_run       c_runs 
  1.31987948   2.59640425   0.01083413   0.04674557   0.33777318   0.09355528 
        crbi      c_walks      leagueN    divisionW     put_outs      assists 
  0.09780402   0.07189612  13.68370191 -54.65877750   0.11852289   0.01606037 
      errors  new_leagueN 
 -0.70358655   8.61181213 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">coef</span>(ridge_mod)[<span class="sc">-</span><span class="dv">1</span>,<span class="dv">60</span>]<span class="sc">^</span><span class="dv">2</span>) <span class="co"># Calculate L2 norm squared</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3261.554</code></pre>
</div>
</div>
<p>Comparing 60th <span class="math inline">\(\lambda\)</span> value and 70th <span class="math inline">\(\lambda\)</span> value. We can observe that the L2 norm squared of the coefficients decreases when lambda value increases.</p>
<p>Here, we use <code>predict()</code> function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># defined for glmnet output</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> ridge_mod, <span class="at">newx =</span> x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Employing cross-validation using the <code>cv.glmnet()</code> function to select the optimal tuning parameter.</p>
<p>Instead of arbitrarily selecting a value for <span class="math inline">\(\lambda\)</span>, a more robust approach involves employing cross-validation to systematically determine the optimal tuning parameter. This can be accomplished through the utilization of the built-in cross-validation function, <code>cv.glmnet()</code>. By default, the function conducts 10-fold cross-validation; however, this setting can be modified through the use of the appropriate function argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># set seed.</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>cv.out.ridge <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(x, y, <span class="at">alpha =</span> <span class="dv">0</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv.out.ridge)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">log</span>(cv.out.ridge<span class="sc">$</span>lambda.min), <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="vignette_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># getting the lambda with the least MSE</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>bestlam <span class="ot">&lt;-</span> cv.out.ridge<span class="sc">$</span>lambda.min</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>bestlam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 25.52821</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">log</span>(bestlam) <span class="co"># where the red line is.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.239784</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(x,y,<span class="at">alpha=</span><span class="dv">0</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>reg_coef <span class="ot">&lt;-</span> <span class="fu">predict</span>(out,<span class="at">type=</span><span class="st">"coefficients"</span>,<span class="at">s=</span>bestlam)[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>reg_coef</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  (Intercept)        at_bat          hits        hm_run          runs 
 8.112693e+01 -6.815959e-01  2.772312e+00 -1.365680e+00  1.014826e+00 
          rbi         walks         years      c_at_bat        c_hits 
 7.130224e-01  3.378558e+00 -9.066800e+00 -1.199478e-03  1.361029e-01 
     c_hm_run        c_runs          crbi       c_walks       leagueN 
 6.979958e-01  2.958896e-01  2.570711e-01 -2.789666e-01  5.321272e+01 
    divisionW      put_outs       assists        errors   new_leagueN 
-1.228345e+02  2.638876e-01  1.698796e-01 -3.685645e+00 -1.810510e+01 </code></pre>
</div>
</div>
<p>The model resulting from ridge regression is deemed optimal. It is noteworthy that none of the coefficients within this model attain a value of zero. It is imperative to acknowledge that ridge regression does not inherently facilitate variable selection.</p>
<hr>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lasso Regression</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">^</span><span class="fu">seq</span>(<span class="dv">10</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="at">length =</span> <span class="dv">100</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>lasso.mod <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(x, y, <span class="at">alpha=</span><span class="dv">1</span>, <span class="at">lambda=</span>grid) <span class="co"># alpha=1, showing lasso regression</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lasso.mod, <span class="at">xvar=</span><span class="st">"lambda"</span>, <span class="at">label =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="vignette_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Through the graph above, we can observe that as the x-axis (Log Lambda) goes right, which indicates that the value of <span class="math inline">\(\lambda\)</span> increases, the coefficients gradually converge to zero. Some of the coefficient will be exactly zero, because lasso regression does variable selection.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># set seed</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>cv.out.lasso <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(x, y, <span class="at">alpha =</span> <span class="dv">1</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cv.out.lasso)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="fu">log</span>(cv.out.lasso<span class="sc">$</span>lambda.min), <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">lty=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="vignette_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># getting the lambda with the least MSE</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>bestlam <span class="ot">&lt;-</span> cv.out.lasso<span class="sc">$</span>lambda.min</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>bestlam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.674375</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">log</span>(bestlam) <span class="co"># where the red line is</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9837159</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(x,y,<span class="at">alpha=</span><span class="dv">1</span>,<span class="at">lambda=</span>grid)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>lasso_coef <span class="ot">&lt;-</span> <span class="fu">predict</span>(out,<span class="at">type=</span><span class="st">"coefficients"</span>,<span class="at">s=</span>bestlam)[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,]</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>lasso_coef</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> (Intercept)       at_bat         hits       hm_run         runs          rbi 
 123.6500045   -1.5549984    5.6819438    0.0000000    0.0000000    0.0000000 
       walks        years     c_at_bat       c_hits     c_hm_run       c_runs 
   4.7413409   -9.4890186    0.0000000    0.0000000    0.5171481    0.6587402 
        crbi      c_walks      leagueN    divisionW     put_outs      assists 
   0.3916899   -0.5305906   32.0825645 -119.2543259    0.2724837    0.1738553 
      errors  new_leagueN 
  -2.0485506    0.0000000 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(out,<span class="at">type=</span><span class="st">"coefficients"</span>,<span class="at">s=</span><span class="dv">0</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,] <span class="co"># compare when lambda = 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> (Intercept)       at_bat         hits       hm_run         runs          rbi 
 164.0049755   -1.9947754    7.5106736    4.1392300   -2.3324269   -0.9699386 
       walks        years     c_at_bat       c_hits     c_hm_run       c_runs 
   6.2401288   -3.9683382   -0.1626764    0.1287533   -0.1022970    1.4310700 
        crbi      c_walks      leagueN    divisionW     put_outs      assists 
   0.7727455   -0.8140598   62.3363000 -116.9873548    0.2823420    0.3680155 
      errors  new_leagueN 
  -3.3569606  -24.7353600 </code></pre>
</div>
</div>
<hr>
</section>
<section id="fitting-the-model" class="level3">
<h3 class="anchored" data-anchor-id="fitting-the-model">Fitting the Model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>hitters_train <span class="sc">%&gt;%</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(is.numeric) <span class="sc">%&gt;%</span> <span class="co"># selecting numeric columns</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cor</span>(<span class="at">use =</span> <span class="st">"pairwise.complete.obs"</span>) <span class="sc">%&gt;%</span> <span class="co"># handling missing data in Salary</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">corrplot</span>(<span class="at">type =</span> <span class="st">"lower"</span>, <span class="at">diag =</span> <span class="cn">FALSE</span>) <span class="co"># printing lower half of matrix</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="vignette_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Through the visualization of the correlation matrix depicted above, robust positive linear correlations show among variables such as <code>years</code>, <code>c_hits</code>, <code>c_runs</code>, <code>crbi</code>, and <code>c_walks</code>. Similarly, substantial positive correlations are observed among <code>at_bat</code>, <code>hits</code>, <code>runs</code>, <code>rbi</code>, and <code>walks</code>. To mitigate the collinearity evident in these relationships, the introduction of the step_pca() procedure will be considered.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>hitters_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(salary <span class="sc">~</span> . , <span class="at">data =</span> hitters_train) <span class="sc">%&gt;%</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_linear</span>(salary, </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">impute_with =</span> <span class="fu">imp_vars</span>(c_hits, c_runs, crbi, c_walks, </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                                            c_at_bat), <span class="at">skip =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(hits, hm_run, runs, rbi, walks, </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">num_comp =</span> <span class="dv">1</span>, <span class="at">prefix =</span> <span class="st">"first_pc"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(years, c_hits, c_runs, crbi, c_walks, c_at_bat,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">num_comp =</span> <span class="dv">1</span>, <span class="at">prefix =</span> <span class="st">"second_pc"</span>)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="fu">prep</span>(hitters_recipe) <span class="sc">%&gt;%</span> <span class="fu">bake</span>(<span class="at">new_data =</span> hitters_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 255 × 11
   at_bat c_hm_run put_outs assists errors salary league_N division_W
    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
 1 -0.518   -0.795  -0.605    1.23   0.122  100     -0.912      0.979
 2 -0.360   -0.725  -0.527    1.28   1.64    75      1.09       0.979
 3 -1.20    -0.737  -0.672    0.480  1.19   175     -0.912      0.979
 4 -1.60    -0.516  -0.320   -0.619 -0.944  135      1.09       0.979
 5  0.208   -0.609  -0.0449  -0.711 -0.487  100      1.09      -1.02 
 6  0.290   -0.760   0.240   -0.619 -0.944  115     -0.912      0.979
 7 -0.707   -0.737   0.525   -0.356 -0.335   90      1.09       0.979
 8 -1.26    -0.749   0.117   -0.569 -0.487   67.5   -0.912     -1.02 
 9 -1.04    -0.260  -0.668   -0.179 -0.487   NA      1.09       0.979
10 -1.03    -0.423   0.0501  -0.597 -1.10   180     -0.912     -1.02 
# ℹ 245 more rows
# ℹ 3 more variables: new_league_N &lt;dbl&gt;, first_pc1 &lt;dbl&gt;, second_pc1 &lt;dbl&gt;</code></pre>
</div>
</div>
<p>First, we make sure to normalize all the predictors, which is usually a good idea when doing PCA, so that they’re on a level playing field. After that, we pick out two principal components. The first one captures all the shared info from the first bunch of five correlated predictors, and the second one does the same for the second bunch.</p>
<hr>
</section>
<section id="elastic-net-regression" class="level3">
<h3 class="anchored" data-anchor-id="elastic-net-regression">Elastic Net Regression</h3>
<p>Elastic Net regression is a regularization technique that combines both L1 (Lasso) and L2 (Ridge) regularization penalties in the linear regression model. In other words, Elastic Net incorporates both the absolute values of the coefficients (L1 penalty) and the squared values of the coefficients (L2 penalty) in the optimization objective. The mixture argument specifies the amount of different types of regularization; <code>mixture</code> = 0 specifies only ridge regularization and <code>mixture</code> = 1 specifies only lasso regularization. Setting mixture to a value between 0 and 1, which results in a mixture of L1 and L2 regularization, or what is often called an “elastic net.”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the model specifications</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>enet_spec_hitters <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>(<span class="at">penalty =</span> <span class="fu">tune</span>(), <span class="at">mixture =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>enet_spec_hitters</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear Regression Model Specification (regression)

Main Arguments:
  penalty = tune()
  mixture = tune()

Computational engine: glmnet </code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the parameter grids</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>param_grid_enet <span class="ot">&lt;-</span> <span class="fu">grid_regular</span>(<span class="fu">penalty</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">trans =</span> <span class="fu">identity_trans</span>()) , </span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">mixture</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)), <span class="at">levels =</span> <span class="dv">10</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the workflows</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>workflow_enet <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(hitters_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(enet_spec_hitters)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By using the function <code>grid_regular()</code>, which creates a grid of evenly spaced parameter values. The next step, using the <code>penalty()</code> function to identify the parameter and define the range within the grid we intend to explore. Using <code>trans = identity_trans()</code> to tell R to use the exact values that we specified, from 0 to 1. Setting the levels to 10.</p>
<hr>
</section>
<section id="hyperparameter-tuning" class="level3">
<h3 class="anchored" data-anchor-id="hyperparameter-tuning">Hyperparameter Tuning</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>tune_res_hitters <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  workflow_enet,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> hitters_fold, </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid =</span> param_grid_enet</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>autoplot()</code> creates a great visualization of the information about each metric across each fold for us:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(tune_res_hitters)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Transformation introduced infinite values in continuous x-axis
Transformation introduced infinite values in continuous x-axis</code></pre>
</div>
<div class="cell-output-display">
<p><img src="vignette_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Observing the plot above, we notice that the scale of the y-axis for both metrics is relatively small. This indicates that the resulting performance doesn’t really vary drastically across any of the models we’ve fit. The amount of regularization, on the x-axis, is the penalty hyperparameter, which covers the range of values we specified (zero to one), and the values of mixture are represented by the different-colored lines.</p>
<p>Overall, the models with zero percentage of lasso penalty, or the ridge regression models, do better, as indicated by the red line being consistently higher (or lower) than the others. This implies that it yields better performance to avoid reducing predictors all the way down to zero, as can happen in the case of lasso regression. Models with some non-zero proportion of lasso start to do slightly better as the penalty value increases, although still their performance is not near the level of ridge regression.</p>
<hr>
</section>
<section id="model-selection" class="level3">
<h3 class="anchored" data-anchor-id="model-selection">Model Selection</h3>
<p>The “best” values of these can be selected using select_best(), or using any variation on that function like select_by_one_std_error(), etc. These functions require you to specify a metric that it should use to select, in this case we’ll use the rmse.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>(enet_hitters_metrics <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(tune_res_hitters))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 200 × 8
   penalty mixture .metric .estimator    mean     n std_err .config             
     &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;        &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
 1   0           0 rmse    standard   321.       10 31.9    Preprocessor1_Model…
 2   0           0 rsq     standard     0.501    10  0.0577 Preprocessor1_Model…
 3   0.111       0 rmse    standard   321.       10 31.9    Preprocessor1_Model…
 4   0.111       0 rsq     standard     0.501    10  0.0577 Preprocessor1_Model…
 5   0.222       0 rmse    standard   321.       10 31.9    Preprocessor1_Model…
 6   0.222       0 rsq     standard     0.501    10  0.0577 Preprocessor1_Model…
 7   0.333       0 rmse    standard   321.       10 31.9    Preprocessor1_Model…
 8   0.333       0 rsq     standard     0.501    10  0.0577 Preprocessor1_Model…
 9   0.444       0 rmse    standard   321.       10 31.9    Preprocessor1_Model…
10   0.444       0 rsq     standard     0.501    10  0.0577 Preprocessor1_Model…
# ℹ 190 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(tune_res_hitters, <span class="at">metric =</span> <span class="st">"rmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  penalty mixture .metric .estimator  mean     n std_err .config               
    &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                 
1   0           0 rmse    standard    321.    10    31.9 Preprocessor1_Model001
2   0.111       0 rmse    standard    321.    10    31.9 Preprocessor1_Model002
3   0.222       0 rmse    standard    321.    10    31.9 Preprocessor1_Model003
4   0.333       0 rmse    standard    321.    10    31.9 Preprocessor1_Model004
5   0.444       0 rmse    standard    321.    10    31.9 Preprocessor1_Model005</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>(best_enet <span class="ot">&lt;-</span> <span class="fu">select_by_one_std_err</span>(tune_res_hitters, <span class="fu">desc</span>(penalty), <span class="fu">desc</span>(mixture),<span class="at">metric =</span> <span class="st">"rmse"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  penalty mixture .metric .estimator  mean     n std_err .config    .best .bound
    &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;
1       1       1 rmse    standard    322.    10    31.7 Preproces…  321.   353.</code></pre>
</div>
</div>
<hr>
</section>
<section id="fit-chosed-model" class="level3">
<h3 class="anchored" data-anchor-id="fit-chosed-model">Fit chosed model</h3>
<p>These values of penalty and mixture can then be used with finalize_workflow() to update/finalize the recipes by replacing tune() with the value of best_enet. Now, these best models should be fit again, this time using the whole training data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Finalize enet model</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>final_enet_wf <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(workflow_enet, best_enet)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>final_enet_wf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
5 Recipe Steps

• step_dummy()
• step_normalize()
• step_impute_linear()
• step_pca()
• step_pca()

── Model ───────────────────────────────────────────────────────────────────────
Linear Regression Model Specification (regression)

Main Arguments:
  penalty = 1
  mixture = 1

Computational engine: glmnet </code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>final_enet_fit <span class="ot">&lt;-</span> <span class="fu">fit</span>(final_enet_wf, hitters_train)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co"># final_enet_fit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These final models can now be applied on our testing data sets to assess their abilities to generalize to brand new data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># enet model</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">augment</span>(final_enet_fit, <span class="at">new_data =</span> hitters_test) <span class="sc">%&gt;%</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse</span>(<span class="at">truth =</span> salary, <span class="at">estimate =</span> .pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard        363.</code></pre>
</div>
</div>
<section id="learn-about-shrinkage-methods" class="level4">
<h4 class="anchored" data-anchor-id="learn-about-shrinkage-methods">Learn about Shrinkage Methods</h4>
<ul>
<li><p>https://www.youtube.com/watch?v=lLlG5xkyqIA</p></li>
<li><p>https://busigence.com/blog/shrinkage-methods-in-linear-regression/</p></li>
</ul>
</section>
<section id="learn-about-elastic-net-regression" class="level4">
<h4 class="anchored" data-anchor-id="learn-about-elastic-net-regression">Learn about Elastic Net Regression</h4>
<ul>
<li><p>https://www.youtube.com/watch?v=1dKRdX9bfIo</p></li>
<li><p>https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.ElasticNet.html</p></li>
</ul>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>